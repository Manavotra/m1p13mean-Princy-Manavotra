<div *ngIf="showForm">
  <h3>{{ editingItem ? 'Modifier' : 'Ajouter' }}</h3>

  <ng-container
    *ngTemplateOutlet="renderFields;
                      context:{ model: currentModel,
                                fields: fields,
                                isSearch: false }">
  </ng-container>

  <!-- Hint d'édition -->
  <p *ngIf="editingItem && editHint"
     style="margin:8px 0; padding:10px 14px; background:#fef9c3; border:1px solid #fde68a;
            border-radius:6px; color:#854d0e; font-size:14px;">
    {{ editHint }}
  </p>

  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <button type="button"
            [disabled]="isProcessing"
            (click)="editingItem ? save() : submit()">
      {{ isProcessing ? 'Traitement...' : (editingItem ? 'Enregistrer' : 'Enregistrer') }}
    </button>

    <!-- Bouton action secondaire (ex: Passer commande) -->
    <button *ngIf="editingItem && editActionLabel"
            type="button"
            [disabled]="isProcessing"
            (click)="save(); editActionClicked.emit(editingItem)"
            style="background:#2563eb; color:white; border:none; border-radius:6px;
                   padding:8px 16px; font-weight:600; cursor:pointer;">
      {{ editActionLabel }}
    </button>
  </div>
</div>

<hr>
<div *ngIf="showSearch">
  <h3>Recherche</h3>

  <ng-container
    *ngTemplateOutlet="renderFields;
                      context:{ model: searchModel,
                                fields: searchFields,
                                isSearch: true }">
  </ng-container>

  <button type="button"
          [disabled]="isProcessing"
          (click)="search()">
    Rechercher
  </button>

  <button type="button"
          [disabled]="isProcessing"
          (click)="resetSearch()">
    Reset
  </button>
</div>


<!-- ===== TABLE LISTING ===== -->
<table *ngIf="showTable" border="1">
  <tr>
    <th *ngFor="let field of fields; trackBy: trackByIndex">
      {{ getFieldLabel(field) }}
    </th>
    <th>Actions</th>
  </tr>

  <tr *ngFor="let item of items; trackBy: trackByIndex">
    <td *ngFor="let field of fields; trackBy: trackByIndex">

      <!-- ===== NESTED DISPLAY ===== -->
      <ng-container *ngIf="field.type === 'nested'">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
          <tr *ngFor="let subField of field.fields">
            <td style="border:1px solid #eee; padding:4px; font-weight:600;">
              {{ getFieldLabel(subField) }}
            </td>
            <td style="border:1px solid #eee; padding:4px;">
              {{ item[field.name]?.[subField.name] || '—' }}
            </td>
          </tr>
        </table>
      </ng-container>

      <!-- ===== SUBDOCUMENT DISPLAY ===== -->
      <ng-container *ngIf="field.type === 'subdocument'">
        <div *ngIf="!item[field.name] || item[field.name].length === 0">—</div>
        <table *ngIf="item[field.name]?.length > 0"
               style="width:100%; border-collapse:collapse; font-size:12px;">
          <tr style="background:#f3f3f3;">
            <th *ngFor="let subField of field.fields"
                style="border:1px solid #ddd; padding:4px; text-align:left;">
              {{ getFieldLabel(subField) }}
            </th>
          </tr>
          <tr *ngFor="let sub of item[field.name]; trackBy: trackByIndex">
            <td *ngFor="let subField of field.fields"
                style="border:1px solid #eee; padding:4px;">
              <ng-container *ngIf="sub[subField.name]?._id; else normalValue">
                {{ sub[subField.name][subField.displayField || 'name'] || sub[subField.name]._id }}
              </ng-container>
              <ng-template #normalValue>{{ sub[subField.name] }}</ng-template>
            </td>
          </tr>
        </table>
      </ng-container>

      <!-- ===== RELATION DISPLAY ===== -->
      <span *ngIf="field.type !== 'nested' && field.type !== 'subdocument' && item[field.name]?._id">
        {{ item[field.name].name || item[field.name].title || item[field.name].label }}
      </span>

      <!-- ===== ARRAY DISPLAY ===== -->
      <span *ngIf="field.type !== 'nested' && field.type !== 'subdocument' && isArray(item[field.name])">
        {{ item[field.name].join(', ') }}
      </span>

      <!-- ===== IMAGE DISPLAY ===== -->
      <img *ngIf="field.type === 'image' && item[field.name]"
          [src]="getImageUrl(item[field.name])"
          width="60"
          style="border-radius:4px;" />

      <!-- ===== SIMPLE DISPLAY ===== -->
      <span *ngIf="field.type !== 'nested'
                    && field.type !== 'subdocument'
                    && field.type !== 'image'
                    && !item[field.name]?._id
                    && !isArray(item[field.name])">
        {{ item[field.name] }}
      </span>

    </td>

    <td>
      <button *ngIf="canEdit" type="button" [disabled]="isProcessing" (click)="edit(item)">
        Modifier
      </button>
      <button *ngIf="canDelete" type="button" [disabled]="isProcessing" (click)="delete(item._id)">
        Supprimer
      </button>
    </td>
  </tr>
</table>


<!-- ===================================================== -->
<!-- ===== TEMPLATE RÉCURSIF POUR LES CHAMPS ===== -->
<!-- ===================================================== -->

<ng-template #renderFields
             let-model="model"
             let-fields="fields"
             let-isSearch="isSearch">

  <div *ngFor="let field of fields; trackBy: trackByIndex"
       style="margin-bottom:10px">

    <!-- ===== RANGE DATE ===== -->
    <div *ngIf="field.type === 'range-date'">
      <label>{{ getFieldLabel(field) }}</label>
      <input type="date" [(ngModel)]="model[field.name + '_from']" [placeholder]="getFieldLabel(field) + ' from'" />
      <input type="date" [(ngModel)]="model[field.name + '_to']" [placeholder]="getFieldLabel(field) + ' to'" />
    </div>

    <!-- ===== RANGE NUMBER ===== -->
    <div *ngIf="field.type === 'range-number'">
      <label>{{ getFieldLabel(field) }}</label>
      <input type="number" [(ngModel)]="model[field.name + '_min']" [placeholder]="getFieldLabel(field) + ' min'" />
      <input type="number" [(ngModel)]="model[field.name + '_max']" [placeholder]="getFieldLabel(field) + ' max'" />
    </div>

    <!-- ===== IMAGE UPLOAD ===== -->
    <div *ngIf="field.type === 'image'">
      <label>{{ getFieldLabel(field) }}</label>
      <input type="file" (change)="onFileChange($event, model, field.name)" />
      <div *ngIf="model[field.name] && isImagePath(model[field.name])">
        <img [src]="getImageUrl(model[field.name])" width="100" style="margin-top:5px; border:1px solid #ccc;" />
      </div>
    </div>

    <!-- ===== INPUT SIMPLE ===== -->
    <ng-container *ngIf="field.type !== 'nested'
                && field.type !== 'array'
                && field.type !== 'relation'
                && field.type !== 'select'
                && field.type !== 'subdocument'
                && field.type !== 'range-date'
                && field.type !== 'range-number'
                && field.type !== 'image'">
      <label>{{ getFieldLabel(field) }}</label>
      <!-- Champ verrouillé -->
      <div *ngIf="field.locked"
           style="padding:8px 10px; background:#f1f5f9; border:1px solid #e2e8f0;
                  border-radius:6px; color:#64748b; font-style:italic; cursor:not-allowed;">
        {{ model[field.name] !== undefined && model[field.name] !== null ? model[field.name] : '—' }}
      </div>
      <!-- Champ éditable -->
      <input *ngIf="!field.locked"
             [type]="field.type"
             [(ngModel)]="model[field.name]"
             [placeholder]="getFieldLabel(field)" />
    </ng-container>

    <!-- ===== SELECT ENUM ===== -->
    <ng-container *ngIf="field.type === 'select'">
      <label>{{ getFieldLabel(field) }}</label>
      <select [(ngModel)]="model[field.name]">
        <option *ngFor="let opt of field.options; trackBy: trackByIndex" [value]="opt">{{ opt }}</option>
      </select>
    </ng-container>

    <!-- ===== ARRAY SIMPLE ===== -->
    <div *ngIf="field.type === 'array'">
      <label>{{ getFieldLabel(field) }}</label>
      <div *ngFor="let item of model[field.name]; let i = index; trackBy: trackByIndex">
        <input [(ngModel)]="model[field.name][i]" />
        <button type="button" (click)="model[field.name].splice(i, 1)">X</button>
      </div>
      <button type="button" (click)="model[field.name].push('')">Ajouter</button>
    </div>

    <!-- ===== RELATION ===== -->
    <ng-container *ngIf="field.type === 'relation'">
      <label>{{ getFieldLabel(field) }}</label>
      <!-- Champ verrouillé (locked: true) -->
      <div *ngIf="field.locked"
           style="padding:8px 10px; background:#f1f5f9; border:1px solid #e2e8f0;
                  border-radius:6px; color:#64748b; font-style:italic; cursor:not-allowed;">
        {{ getRelationLabel(relationsData[field.name], model[field.name]) }}
      </div>
      <!-- Champ normal -->
      <select *ngIf="!field.locked" [(ngModel)]="model[field.name]">
        <option *ngFor="let r of relationsData[field.name]; trackBy: trackByIndex" [value]="r._id">
          {{ r.name || r.title || r.label }}
        </option>
      </select>
    </ng-container>

    <!-- ===== NESTED ===== -->
    <div *ngIf="field.type === 'nested'"
         style="margin-left:20px; border-left:2px solid #ccc; padding-left:10px">
      <strong>{{ getFieldLabel(field) }}</strong>
      <ng-container *ngIf="isSearch">
        <ng-container *ngTemplateOutlet="renderFields; context:{ model: model[field.name], fields: field.fields, isSearch: true }"></ng-container>
      </ng-container>
      <ng-container *ngIf="!isSearch">
        <ng-container *ngTemplateOutlet="renderFields; context:{ model: model[field.name], fields: field.fields, isSearch: false }"></ng-container>
      </ng-container>
    </div>

    <!-- ===== SUBDOCUMENT ===== -->
    <div *ngIf="field.type === 'subdocument'"
         style="margin-left:20px; border-left:2px solid #4CAF50; padding-left:10px">
      <strong>{{ getFieldLabel(field) }}</strong>
      <ng-container *ngIf="isSearch">
        <ng-container *ngTemplateOutlet="renderFields; context:{ model: model[field.name], fields: field.fields, isSearch: true }"></ng-container>
      </ng-container>
      <ng-container *ngIf="!isSearch">
        <div *ngFor="let subItem of model[field.name]; let i = index; trackBy: trackByIndex"
             style="margin-bottom:10px; padding:10px; border:1px solid #ccc">
          <ng-container *ngTemplateOutlet="renderFields; context:{ model: subItem, fields: field.fields, isSearch: false }"></ng-container>
          <button type="button" (click)="removeSubdocumentItem(field.name, i)">Supprimer ligne</button>
        </div>
        <button type="button" (click)="addSubdocumentItem(field)">Ajouter ligne</button>
      </ng-container>
    </div>

  </div>

</ng-template>