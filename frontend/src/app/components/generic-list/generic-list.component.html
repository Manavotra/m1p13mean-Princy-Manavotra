<h3>{{ editingItem ? 'Modifier' : 'Ajouter' }}</h3>

<!-- ===== FORMULAIRE RÉCURSIF ===== -->
<ng-container
  *ngTemplateOutlet="renderFields;
                     context:{ model: currentModel,
                               fields: fields }">
</ng-container>

<button type="button"
        (click)="editingItem ? save() : submit()">
  {{ editingItem ? 'Enregistrer' : 'Ajouter' }}
</button>

<hr>

<!-- ===== TABLE LISTING ===== -->
<table border="1">
  <tr>
    <th *ngFor="let field of fields">{{ field.name }}</th>
    <th>Actions</th>
  </tr>

  <tr *ngFor="let item of items">
    <td *ngFor="let field of fields">

      <!-- NESTED DISPLAY -->
      <ng-container *ngIf="field.type === 'nested'">
        <div *ngFor="let subField of field.fields">
          <strong>{{ subField.name }}:</strong>
          {{ item[field.name]?.[subField.name] }}
        </div>
      </ng-container>

      <!-- SUBDOCUMENT DISPLAY -->
      <ng-container *ngIf="field.type === 'subdocument'">

        <div *ngIf="item[field.name]?.length === 0">
          —
        </div>

        <ul *ngIf="item[field.name]?.length > 0">
          <li *ngFor="let sub of item[field.name]">
            <span *ngFor="let subField of field.fields; let last = last">
              {{ sub[subField.name] }}<span *ngIf="!last"> | </span>
            </span>
          </li>
        </ul>

      </ng-container>


      <!-- Relation affichée -->
      <span *ngIf="field.type !== 'nested' && item[field.name]?._id">
        {{ item[field.name].name || item[field.name].title }}
      </span>

      <!-- Array affichage -->
      <span *ngIf="field.type !== 'nested' && isArray(item[field.name])">
        {{ item[field.name].join(', ') }}
      </span>

      <!-- Simple -->
      <span *ngIf="field.type !== 'nested'
                    && !item[field.name]?._id
                    && !isArray(item[field.name])">
        {{ item[field.name] }}
      </span>

    </td>

    <td>
      <button (click)="edit(item)">Modifier</button>
      <button (click)="delete(item._id)">Supprimer</button>
    </td>
  </tr>
</table>

<!-- ===================================================== -->
<!-- ===== TEMPLATE RÉCURSIF POUR LES CHAMPS ===== -->
<!-- ===================================================== -->

<ng-template #renderFields
             let-model="model"
             let-fields="fields">

  <div *ngFor="let field of fields" style="margin-bottom:10px">

    <!-- ===== CHAMP COMME TEXT,NUMBER,DATE,EMAIL ===== -->
<input *ngIf="field.type !== 'nested'
              && field.type !== 'array'
              && field.type !== 'relation'
              && field.type !== 'select'
              && field.type !== 'subdocument'"
       [type]="field.type"
       [(ngModel)]="model[field.name]"
       [placeholder]="field.name" />



    <!-- ===== SELECT (ENUM) ===== -->
    <select *ngIf="field.type === 'select'"
            [(ngModel)]="model[field.name]">
      <option *ngFor="let opt of field.options"
              [value]="opt">
        {{ opt }}
      </option>
    </select>

    <!-- ===== ARRAY SIMPLE ===== -->
    <div *ngIf="field.type === 'array'">

      <div *ngFor="let item of model[field.name]; let i = index">
        <input [(ngModel)]="model[field.name][i]" />

        <button type="button"
                (click)="model[field.name].splice(i, 1)">
          X
        </button>
      </div>

      <button type="button"
              (click)="model[field.name].push('')">
        Ajouter
      </button>

    </div>

    <!-- ===== RELATION ===== -->
    <select *ngIf="field.type === 'relation'"
            [(ngModel)]="model[field.name]">
      <option *ngFor="let r of relationsData[field.name]"
              [value]="r._id">
        {{ r.name || r.title || r.label }}
      </option>
    </select>

    <!-- ===== NESTED OBJECT ===== -->
    <div *ngIf="field.type === 'nested'"
         style="margin-left:20px;
                border-left:2px solid #ccc;
                padding-left:10px">

      <strong>{{ field.name }}</strong>

      <ng-container
        *ngTemplateOutlet="renderFields;
                           context:{
                             model: model[field.name],
                             fields: field.fields
                           }">
      </ng-container>

    </div>

    <!-- ===== SUBDOCUMENT ARRAY ===== -->
    <div *ngIf="field.type === 'subdocument'"
        style="margin-left:20px;
                border-left:2px solid #4CAF50;
                padding-left:10px">

      <strong>{{ field.name }}</strong>

      <div *ngFor="let subItem of model[field.name]; let i = index"
          style="margin-bottom:10px;
                  padding:10px;
                  border:1px solid #ccc">

        <!-- Récursion sur les champs internes -->
        <ng-container
          *ngTemplateOutlet="renderFields;
                            context:{
                              model: subItem,
                              fields: field.fields
                            }">
        </ng-container>

        <button type="button"
                (click)="removeSubdocumentItem(field.name, i)">
          Supprimer ligne
        </button>

      </div>

      <button type="button"
              (click)="addSubdocumentItem(field)">
        Ajouter ligne
      </button>

    </div>


  </div>

</ng-template>
