<div class="pg-wrapper">

  <!-- ========== HEADER ========== -->
  <div class="pg-header">
    <div class="pg-title-block">
      <span class="pg-icon">ğŸ›ï¸</span>
      <h2 class="pg-title">Produits</h2>
      <span class="pg-count">{{ items.length }} article{{ items.length > 1 ? 's' : '' }}</span>
    </div>
    <!-- Bouton "Nouveau produit" uniquement pour les vendeurs connectÃ©s -->
    <button class="pg-btn-add" (click)="toggleForm()" *ngIf="isVendeur">
      {{ showFormPanel ? 'âœ• Fermer' : '+ Nouveau produit' }}
    </button>
  </div>

  <app-profile></app-profile> 


  <!-- ========== SEARCH BAR ========== -->
  <div class="pg-search-panel" *ngIf="showSearch">
    <div class="pg-search-grid">

      <div class="pg-field" *ngFor="let field of searchFields">
        <label class="pg-label">{{ getLabel(field) }}</label>

        <!-- Text -->
        <input *ngIf="field.type === 'text'"
               class="pg-input" type="text"
               [(ngModel)]="searchModel[field.name]"
               [placeholder]="getLabel(field)" />

        <!-- Number range -->
        <div *ngIf="field.type === 'range-number'" class="pg-range">
          <input class="pg-input" type="number"
                 [(ngModel)]="searchModel[field.name + '_min']"
                 placeholder="Min" />
          <span class="pg-range-sep">â€“</span>
          <input class="pg-input" type="number"
                 [(ngModel)]="searchModel[field.name + '_max']"
                 placeholder="Max" />
        </div>

        <!-- Number -->
        <input *ngIf="field.type === 'number'"
               class="pg-input" type="number"
               [(ngModel)]="searchModel[field.name]"
               [placeholder]="getLabel(field)" />

        <!-- Select -->
        <select *ngIf="field.type === 'select'" class="pg-input"
                [(ngModel)]="searchModel[field.name]">
          <option value="">-- Tous --</option>
          <option *ngFor="let opt of field.options" [value]="opt">{{ opt }}</option>
        </select>

        <!-- Relation -->
        <select *ngIf="field.type === 'relation'" class="pg-input"
                [(ngModel)]="searchModel[field.name]">
          <option value="">-- Tous --</option>
          <option *ngFor="let r of relationsData[field.name]" [value]="r._id">
            {{ r.name || r.title || r.label }}
          </option>
        </select>

      </div>
    </div>

    <div class="pg-search-actions">
      <button class="pg-btn pg-btn-primary" [disabled]="isProcessing" (click)="search()">
        ğŸ” Rechercher
      </button>
      <button class="pg-btn pg-btn-ghost" [disabled]="isProcessing" (click)="resetSearch()">
        â†º RÃ©initialiser
      </button>
    </div>
  </div>

  <!-- ========== FORM PANEL (vendeur seulement) ========== -->
  <div class="pg-form-panel" *ngIf="showFormPanel && isVendeur">
    <h3 class="pg-form-title">{{ editingItem ? 'âœï¸ Modifier le produit' : 'âœ¨ Nouveau produit' }}</h3>

    <div class="pg-form-grid">
      <div class="pg-field" *ngFor="let field of fields">
        <label class="pg-label">{{ getLabel(field) }}</label>

        <!-- Image upload -->
        <div *ngIf="field.type === 'image'" class="pg-image-upload">
          <input type="file" class="pg-file-input"
                 (change)="onFileChange($event, currentModel, field.name)" />
          <div *ngIf="currentModel[field.name] && isImagePath(currentModel[field.name])" class="pg-preview">
            <img [src]="getImageUrl(currentModel[field.name])" />
          </div>
        </div>

        <!-- Text -->
        <input *ngIf="field.type === 'text'" class="pg-input" type="text"
               [(ngModel)]="currentModel[field.name]"
               [placeholder]="getLabel(field)" />

        <!-- Number -->
        <input *ngIf="field.type === 'number'" class="pg-input" type="number"
               [(ngModel)]="currentModel[field.name]"
               [placeholder]="getLabel(field)" />

        <!-- Select -->
        <select *ngIf="field.type === 'select'" class="pg-input"
                [(ngModel)]="currentModel[field.name]">
          <option value="">-- Choisir --</option>
          <option *ngFor="let opt of field.options" [value]="opt">{{ opt }}</option>
        </select>

        <!-- Relation -->
        <select *ngIf="field.type === 'relation'" class="pg-input"
                [(ngModel)]="currentModel[field.name]">
          <option value="">-- Choisir --</option>
          <option *ngFor="let r of relationsData[field.name]" [value]="r._id">
            {{ r.name || r.title || r.label }}
          </option>
        </select>

      </div>
    </div>

    <div class="pg-form-actions">
      <button class="pg-btn pg-btn-primary" [disabled]="isProcessing"
              (click)="editingItem ? save() : submit()">
        {{ isProcessing ? 'â³ Traitement...' : (editingItem ? 'ğŸ’¾ Enregistrer' : 'âœ… CrÃ©er le produit') }}
      </button>
      <button class="pg-btn pg-btn-ghost" (click)="cancelForm()">Annuler</button>
    </div>
  </div>

  <!-- ========== PRODUCT GRID ========== -->
  <div class="pg-grid">

    <div class="pg-card" *ngFor="let item of items; trackBy: trackById">

      <!-- Image -->
      <div class="pg-card-image">
        <img *ngIf="getImageField(item)" [src]="getImageUrl(getImageField(item)!)" [alt]="item.name" />
        <div *ngIf="!getImageField(item)" class="pg-card-no-image">ğŸ“¦</div>

        <!-- Status badge -->
        <span class="pg-badge" [ngClass]="getBadgeClass(item.status)">
          {{ item.status || 'â€”' }}
        </span>
      </div>

      <!-- Card Body -->
      <div class="pg-card-body">
        <h3 class="pg-card-name">{{ item.name }}</h3>
        <p class="pg-card-desc" *ngIf="item.description">{{ item.description }}</p>

        <!-- Prix + Stock -->
        <div class="pg-card-meta">
          <span class="pg-meta-price" *ngIf="item.price !== undefined">
            {{ item.price | number:'1.0-0' }} Ar
          </span>
          <span class="pg-meta-stock" [ngClass]="{'low': item.stock < 5}">
            ğŸ“¦ {{ item.stock }} en stock
          </span>
        </div>

        <!-- Tags relation -->
        <div class="pg-card-tags">
          <span class="pg-tag" *ngIf="item.category">
            ğŸ·ï¸ {{ item.category?.name || item.category?.title || item.category }}
          </span>
          <span class="pg-tag pg-tag-shop" *ngIf="item.shop">
            ğŸª {{ item.shop?.name || item.shop?.title || item.shop }}
          </span>
        </div>
      </div>

      <!-- ===== CARD FOOTER selon rÃ´le ===== -->
      <div class="pg-card-footer">

        <!-- Non connectÃ© : aucun bouton -->
        <ng-container *ngIf="!currentUser">
          <span class="pg-footer-hint">Connectez-vous pour interagir</span>
        </ng-container>

        <!-- Vendeur : Modifier + Supprimer -->
        <ng-container *ngIf="isVendeur">
          <button class="pg-btn pg-btn-sm pg-btn-edit"
                  [disabled]="isProcessing"
                  (click)="editProduct(item)">
            âœï¸ Modifier
          </button>
          <button class="pg-btn pg-btn-sm pg-btn-delete"
                  [disabled]="isProcessing"
                  (click)="delete(item._id)">
            ğŸ—‘ï¸ Supprimer
          </button>
        </ng-container>

        <!-- Client (DEFAULT) : Favoris + Panier -->
        <ng-container *ngIf="isClient">
          <button class="pg-btn pg-btn-sm pg-btn-fav"
                  [disabled]="isProcessing"
                  (click)="addToFavorites(item)">
            â™¥ Favoris
          </button>
          <button class="pg-btn pg-btn-sm pg-btn-cart"
                  [disabled]="isProcessing"
                  (click)="addToCart(item)">
            ğŸ›’ Panier
          </button>
        </ng-container>

      </div>

    </div>

    <!-- Empty state -->
    <div class="pg-empty" *ngIf="items.length === 0">
      <span class="pg-empty-icon">ğŸ“­</span>
      <p>Aucun produit trouvÃ©</p>
    </div>

  </div>

</div>